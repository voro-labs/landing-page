name: Fly Preview

on:
  pull_request:
    branches:
      - main

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Define preview app name
        id: vars
        run: echo "APP_NAME=${{ github.event.repository.name }}-pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Create Fly app (if not exists)
        run: |
          flyctl apps create ${{ steps.vars.outputs.APP_NAME }} --yes || true
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Set secrets for preview app
        run: |
          cd ${{ secrets.FOLDER__API }}
          flyctl secrets set \
            JWTKEY="${{ secrets.JWTKEY }}" \
            CONNECTIONDB="${{ secrets.CONNECTIONDB }}" \
            EMAILSETTINGS__SMTPSERVER="${{ secrets.EMAILSETTINGS__SMTPSERVER }}" \
            EMAILSETTINGS__SMTPPORT="${{ secrets.EMAILSETTINGS__SMTPPORT }}" \
            EMAILSETTINGS__IMAPSERVER="${{ secrets.EMAILSETTINGS__IMAPSERVER }}" \
            EMAILSETTINGS__IMAPPORT="${{ secrets.EMAILSETTINGS__IMAPPORT }}" \
            EMAILSETTINGS__FROM="${{ secrets.EMAILSETTINGS__FROM }}" \
            EMAILSETTINGS__PASSWORD="${{ secrets.EMAILSETTINGS__PASSWORD }}" \
            KESTREL__CERTIFICATES__DEVELOPMENT__PASSWORD="${{ secrets.KESTREL__CERTIFICATES__DEVELOPMENT__CERTIFICATES__PASSWORD }}" \
            -a ${{ steps.vars.outputs.APP_NAME }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy preview app
        run: |
          cd ${{ secrets.FOLDER__API }}
          flyctl deploy --remote-only -a ${{ steps.vars.outputs.APP_NAME }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Comment preview URL on PR (Vercel-style)
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            **ðŸš€ Preview environment for this PR**

            | Project | Deployment | Preview | Updated (UTC) |
            |--------|------------|---------|---------------|
            | `${{ github.event.repository.name }}` | ðŸŸ¢ Deployed | [Preview](https://${{ steps.vars.outputs.APP_NAME }}.fly.dev) | ${{ github.event.pull_request.updated_at }} |
